<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Code Sandbox</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: #cccccc; height: 100vh; overflow: hidden; }
        .container { display: flex; height: 100vh; }
        .editor-panel { width: 50%; background: #252526; border-right: 1px solid #3e3e42; display: flex; flex-direction: column; }
        .header { padding: 15px 20px; background: #2d2d30; border-bottom: 1px solid #3e3e42; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 18px; color: #cccccc; }
        .run-button { background: #007acc; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .run-button:hover { background: #005a9e; }
        .tabs { display: flex; background: #2d2d30; border-bottom: 1px solid #3e3e42; }
        .tab { padding: 12px 20px; background: #2d2d30; border: none; color: #cccccc; cursor: pointer; border-right: 1px solid #3e3e42; font-size: 14px; }
        .tab:hover { background: #3e3e42; }
        .tab.active { background: #007acc; color: white; }
        .parse-button { position: absolute; top: 10px; right: 10px; background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; z-index: 1000; }
        .parse-button:hover { background: #218838; }
        .parse-button.hidden { display: none; }
        .editor-container { position: relative; flex: 1; overflow: hidden; }
        .editor-wrapper { display: none; height: 100%; }
        .editor-wrapper.active { display: block; }
        .CodeMirror { height: 100% !important; font-size: 14px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; }
        .preview-panel { width: 50%; background: #ffffff; display: flex; flex-direction: column; }
        .preview-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .preview-header h2 { font-size: 16px; color: #495057; }
        .preview-container { flex: 1; position: relative; overflow: hidden; }
        .error-display { display: none; background: #ffebee; color: #c62828; padding: 10px; border-left: 4px solid #f44336; margin: 10px; border-radius: 4px; }
        .preview-iframe { width: 100%; height: 100%; border: none; background: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor-panel">
            <div class="header">
                <h1>Online Code Sandbox</h1>
                <button class="run-button" onclick="runCode()">Run Preview</button>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('html')">HTML</button>
                <button class="tab" onclick="switchTab('css')">CSS</button>
                <button class="tab" onclick="switchTab('js')">JavaScript</button>
            </div>
            <div class="editor-container">
                <button class="parse-button" onclick="separateCode()" title="分离HTML中的CSS和JavaScript代码">分离代码</button>
                <div class="editor-wrapper active" id="html-editor">
                    <textarea id="html-code"></textarea>
                </div>
                <div class="editor-wrapper" id="css-editor">
                    <textarea id="css-code"></textarea>
                </div>
                <div class="editor-wrapper" id="js-editor">
                    <textarea id="js-code"></textarea>
                </div>
            </div>
        </div>
        <div class="preview-panel">
            <div class="preview-header">
                <h2>Preview Result</h2>
            </div>
            <div class="preview-container">
                <div class="error-display" id="error-display"></div>
                <iframe class="preview-iframe" id="preview-iframe" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>

    <script>
        var editors = {};

        function initializeEditors() {
            editors.html = CodeMirror.fromTextArea(document.getElementById('html-code'), {
                mode: 'htmlmixed',
                lineNumbers: true,
                autoCloseTags: true,
                autoCloseBrackets: true
            });

            editors.css = CodeMirror.fromTextArea(document.getElementById('css-code'), {
                mode: 'css',
                lineNumbers: true,
                autoCloseBrackets: true
            });

            editors.js = CodeMirror.fromTextArea(document.getElementById('js-code'), {
                mode: 'javascript',
                lineNumbers: true,
                autoCloseBrackets: true
            });

            editors.html.on('change', function() {
                checkForEmbeddedCode();
            });

            setDefaultCode();
        }

        function setDefaultCode() {
            var htmlContent = '<div class="container">' + '\n' +
                '  <h1>Hello World!</h1>' + '\n' +
                '  <p>Welcome to the code sandbox!</p>' + '\n' +
                '  <button onclick="changeColor()">Change Color</button>' + '\n' +
                '</div>';
            
            var cssContent = '.container {' + '\n' +
                '  text-align: center;' + '\n' +
                '  padding: 50px;' + '\n' +
                '  font-family: Arial, sans-serif;' + '\n' +
                '}' + '\n\n' +
                'h1 {' + '\n' +
                '  color: #333;' + '\n' +
                '  margin-bottom: 20px;' + '\n' +
                '}' + '\n\n' +
                'button {' + '\n' +
                '  background: #007acc;' + '\n' +
                '  color: white;' + '\n' +
                '  border: none;' + '\n' +
                '  padding: 10px 20px;' + '\n' +
                '  border-radius: 5px;' + '\n' +
                '  cursor: pointer;' + '\n' +
                '}';
            
            var jsContent = 'function changeColor() {' + '\n' +
                '  const colors = ["#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#feca57"];' + '\n' +
                '  const randomColor = colors[Math.floor(Math.random() * colors.length)];' + '\n' +
                '  document.querySelector("h1").style.color = randomColor;' + '\n' +
                '  console.log("Color changed to: " + randomColor);' + '\n' +
                '}';

            editors.html.setValue(htmlContent);
            editors.css.setValue(cssContent);
            editors.js.setValue(jsContent);
        }

        function runCode() {
            try {
                var htmlContent = editors.html.getValue();
                var cssContent = editors.css.getValue();
                var jsContent = editors.js.getValue();
                
                var fullHTML = buildFullHTML(htmlContent, cssContent, jsContent);
                
                var iframe = document.getElementById('preview-iframe');
                var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(fullHTML);
                iframeDoc.close();
                
                console.log('代码预览更新成功');
            } catch (error) {
                console.error('预览错误:', error);
                showError('预览失败: ' + error.message);
            }
        }

        function buildFullHTML(html, css, js) {
            var fullHTML = '<!DOCTYPE html>' + '\n' +
                '<html lang="zh-CN">' + '\n' +
                '<head>' + '\n' +
                '<meta charset="UTF-8">' + '\n' +
                '<meta name="viewport" content="width=device-width, initial-scale=1.0">' + '\n' +
                '<title>Preview</title>' + '\n';
            
            if (css) {
                fullHTML += '<style>' + '\n' + css + '\n' + '</style>' + '\n';
            }
            
            fullHTML += '</head>' + '\n' + '<body>' + '\n';
            
            if (html) {
                fullHTML += html + '\n';
            }
            
            if (js) {
                fullHTML += '<script>' + '\n' + js + '\n' + '</script>' + '\n';
            }
            
            fullHTML += '</body>' + '\n' + '</html>';
            
            return fullHTML;
        }

        function switchTab(tabName) {
            var tabs = document.querySelectorAll('.tab');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            var editors_wrappers = document.querySelectorAll('.editor-wrapper');
            editors_wrappers.forEach(function(wrapper) {
                wrapper.classList.remove('active');
            });
            
            var activeTab = document.querySelector('.tab[onclick="switchTab(\'' + tabName + '\')"]');
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            var activeEditor = document.getElementById(tabName + '-editor');
            if (activeEditor) {
                activeEditor.classList.add('active');
            }
            
            if (editors[tabName]) {
                setTimeout(function() {
                    editors[tabName].refresh();
                }, 10);
            }
        }
        
        function showError(message) {
            var errorDisplay = document.getElementById('error-display');
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            setTimeout(function() {
                errorDisplay.style.display = 'none';
            }, 5000);
        }

        function parseHTMLContent(htmlContent) {
            var result = {
                html: '',
                css: '',
                js: ''
            };

            var styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
            var cssMatches = [];
            var match;
            while ((match = styleRegex.exec(htmlContent)) !== null) {
                cssMatches.push(match[1].trim());
            }
            result.css = cssMatches.join('\n\n');

            var scriptRegex = /<script[^>]*>([\s\S]*?)<\/script>/gi;
            var jsMatches = [];
            while ((match = scriptRegex.exec(htmlContent)) !== null) {
                var scriptContent = match[1].trim();
                if (scriptContent && !match[0].includes('src=')) {
                    jsMatches.push(scriptContent);
                }
            }
            result.js = jsMatches.join('\n\n');

            var cleanHTML = htmlContent
                .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                .replace(/^\s*\n/gm, '')
                .trim();

            result.html = cleanHTML;

            return result;
        }

        function separateCode() {
            try {
                var htmlContent = editors.html.getValue();
                
                if (htmlContent.includes('<style') || htmlContent.includes('<script')) {
                    var parsed = parseHTMLContent(htmlContent);
                    
                    if (parsed.html) {
                        editors.html.setValue(parsed.html);
                    }
                    if (parsed.css) {
                        editors.css.setValue(parsed.css);
                    }
                    if (parsed.js) {
                        editors.js.setValue(parsed.js);
                    }
                    
                    console.log('代码分离完成！');
                    showMessage('代码已成功分离到各个编辑器中！');
                } else {
                    showMessage('当前HTML代码中未检测到CSS或JavaScript内容。');
                }
            } catch (error) {
                console.error('代码分离错误:', error);
                showError('代码分离失败: ' + error.message);
            }
        }

        function showMessage(message) {
            var errorDisplay = document.getElementById('error-display');
            errorDisplay.style.background = '#e8f5e8';
            errorDisplay.style.color = '#2e7d32';
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            setTimeout(function() {
                errorDisplay.style.display = 'none';
                errorDisplay.style.background = '#ffebee';
                errorDisplay.style.color = '#c62828';
            }, 3000);
        }

        function checkForEmbeddedCode() {
            var parseButton = document.querySelector('.parse-button');
            if (!parseButton) return;

            var htmlContent = editors.html.getValue();
            var hasEmbeddedCode = htmlContent.includes('<style') || htmlContent.includes('<script');
            
            if (hasEmbeddedCode) {
                parseButton.classList.remove('hidden');
                parseButton.style.display = 'block';
            } else {
                parseButton.classList.add('hidden');
                parseButton.style.display = 'none';
            }
        }

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Code sandbox initializing...');
            initializeEditors();
            runCode();
        });
    </script>
</body>
</html>